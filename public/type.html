<!DOCTYPE html>
<html>
    <head>
        <script>
            var words = "" // the randomly generated words
            var wordsArray = [] // same as words except each word is an element in the array
            var wrongLetters = [] // format: [[wordIndex, charIndex], ...]
            var timing = false // keeps track of whether the timer has already been started
            var start = null // starting time
            var end = null // ending time

            function setUpEvent() {
                let text = document.getElementById('text');
                
                // this runs every time a key is pressed
                text.addEventListener('input', function () {
                    let typed = text.value;
                    let typedWords = typed.split(" ");
                    
                    let html = "";

                    if (!timing) {
                        // start timer
                        start = new Date()
                        timing = true
                    }
                    
                    // checking if last word matches, or a space is entered after last word
                    // to know if the user is done
                    if (typedWords.length-1 === wordsArray.length || 
                            (typedWords.length === wordsArray.length) && 
                            typedWords[typedWords.length-1] == wordsArray[wordsArray.length-1]) {
                        // stop timer
                        end = new Date()
                        timing = false

                        // calculate words per minute
                        let numChars = wordsArray.join("").length
                        // dividing by 5 since the average english word length is about 5 
                        let numWords = numChars / 5
                        let seconds = (end - start) / 1000
                        let minutes = seconds / 60
                        // since chars that weren't typed also need to be considered as wrong
                        let numCharsWrong = wrongLetters.length + numChars - typedWords.join("").length
                        let accuracy = (numChars - numCharsWrong) / numChars 
                        // this is raw wpm without without penalizing for accuracy
                        let rawWpm = numWords / minutes
                        // penalizing wpm depending on accuracy
                        // this is so that if someone gets a very low accuracy, they won't get a high wpm
                        let wpm = rawWpm * accuracy

                        // storing in local storage so that score.html can access and display them
                        window.localStorage.setItem('wpm', wpm)
                        window.localStorage.setItem('accuracy', accuracy)
                        window.localStorage.setItem('rawWpm', rawWpm)

                        // sending the data to the server through POST method
                        let data = {'wpm': wpm, 'accuracy': accuracy}
                        let username = window.localStorage.getItem('username')
                        let password = window.localStorage.getItem('password')
                        if (username != null && password != null) {
                            data['username'] = username
                            data['password'] = password
                        }
                        fetch('/score', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        })
                        .then(res => {
                            return res.text()
                        })
                        .then(text => {
                            document.open()
                            document.write(text)
                            document.close()
                        })
                        .catch(err => {
                            console.log(err)
                        })
                    }

                    // iterating through all words
                    for (let i = 0; i < wordsArray.length; i++) {
                        // checking if the current word has already been typed
                        if (i < typedWords.length - 1) {
                            // changing style color depending on whether the word was typed correctly
                            if (typedWords[i] === wordsArray[i]) {
                                html += `<span style="color: green;">${wordsArray[i]}</span> `;
                            } else {
                                html += `<span style="color: red;">${wordsArray[i]}</span> `;
                            }
                        // checking if the current word is the word being typed
                        } else if (i === typedWords.length - 1) {
                            // changing style color depending on whether the word was typed correctly
                            if (typedWords[i] === wordsArray[i].substring(0, typedWords[i].length)) {
                                html += `<span style="color: black; text-decoration: underline;">${wordsArray[i]}</span> `;
                            } else {
                                html += `<span style="color: red; text-decoration: underline;">${wordsArray[i]}</span> `;
                            }
                            // checking if the letter that was just typed is wrong
                            let charIndex = typedWords[i].length-1
                            if (charIndex < wordsArray.length && typedWords[i].charAt(charIndex) != wordsArray[i].charAt(charIndex)) {
                                // checking if the letter has not yet been counted as wrong
                                if (!contains(i, charIndex)) {
                                    wrongLetters.push([i, charIndex])
                                }
                            }
                        // if the current word has not yet been typed
                        } else {
                            html += `<span>${wordsArray[i]}</span> `;
                        }
                    }

                    document.getElementById("words").innerHTML = html;
                });
            }
            
            // checks if wrongLetters contains the array [wordIndex, charIndex]
            function contains(wordIndex, charIndex) {
                for (let i = 0; i < wrongLetters.length; i++) {
                    if (wrongLetters[i][0] === wordIndex && wrongLetters[i][1] === charIndex) {
                        return true;
                    }
                }
                return false;
            }

            // getting the randomly generated words from the server through POST method
            function getWords(numWords) {
                wrongLetters = []
                let data = {'numWords': numWords}
                fetch('/type', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                })
                .then(res => {
                    return res.text()
                })
                .then(text => {
                    // it recieves the generated words from the server and stores it
                    words = text
                    wordsArray = text.split(" ")
                    document.getElementById('words').innerText = words
                })
                .catch(err => {
                    console.log(err)
                })
            }

            // disables paste so that users can't cheat
            function disablePaste() {
                let text = document.getElementById('text');
                text.onpaste = e => e.preventDefault();
            }
        </script>
    </head>
    <div class="num_words_options">
        <input type="button" value="10" onclick="getWords(10)">
        <input type="button" value="25" onclick="getWords(25)">
        <input type="button" value="50" onclick="getWords(50)">
        <input type="button" value="100" onclick="getWords(100)">
    </div>
    <body onload="getWords(25); disablePaste(); setUpEvent()">
        <div id="words"></div>
        <input type="text" id="text">
    </body>
</html>